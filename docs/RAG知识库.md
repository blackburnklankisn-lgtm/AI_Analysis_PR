# 方案 B：RAG 知识库设计与实施方案

## 一、方案概述

**RAG (Retrieval Augmented Generation)** 是一种将**向量语义检索**与**大语言模型生成**相结合的技术路线。

### 核心思想

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG 工作流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐    ┌──────────────┐    ┌─────────────────────┐│
│  │ 新 PR   │───>│ 向量化查询   │───>│ 向量数据库检索      ││
│  └─────────┘    └──────────────┘    └─────────────────────┘│
│                                              │               │
│                                              ▼               │
│                                    ┌─────────────────────┐  │
│                                    │ Top-K 相似历史 PR  │  │
│                                    └─────────────────────┘  │
│                                              │               │
│                                              ▼               │
│  ┌─────────┐    ┌──────────────┐    ┌─────────────────────┐│
│  │诊断报告 │<───│ LLM 推理生成 │<───│ 上下文 + 新 PR     ││
│  └─────────┘    └──────────────┘    └─────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         RAG 知识库系统                               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     数据导入层                               │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐               │   │
│  │  │ Jira API  │  │ CSV 导入  │  │ 手动录入  │               │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘               │   │
│  │        └──────────────┼──────────────┘                      │   │
│  │                       ▼                                      │   │
│  │              ┌─────────────────┐                            │   │
│  │              │   数据清洗管道   │                            │   │
│  │              └────────┬────────┘                            │   │
│  └───────────────────────┼─────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     存储层                                   │   │
│  │  ┌───────────────────────┐  ┌─────────────────────────────┐│   │
│  │  │    向量数据库          │  │       元数据存储             ││   │
│  │  │  (ChromaDB/Qdrant)    │  │  (SQLite/PostgreSQL)        ││   │
│  │  │                       │  │                             ││   │
│  │  │  - 文本向量索引        │  │  - PR 结构化字段            ││   │
│  │  │  - 相似度检索          │  │  - 标签、分类               ││   │
│  │  └───────────────────────┘  └─────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     检索层                                   │   │
│  │  ┌───────────────────────┐  ┌─────────────────────────────┐│   │
│  │  │    Embedding 模型     │  │       重排序模型            ││   │
│  │  │  (bge-large-zh)       │  │  (Cross-Encoder) [可选]     ││   │
│  │  └───────────────────────┘  └─────────────────────────────┘│   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     推理层                                   │   │
│  │  ┌───────────────────────┐  ┌─────────────────────────────┐│   │
│  │  │    LLM (Gemini)       │  │       Prompt 模板           ││   │
│  │  └───────────────────────┘  └─────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

| 组件 | 技术选型 | 说明 |
|---|---|---|
| **向量数据库** | ChromaDB (轻量) / Qdrant (生产级) | 存储文本向量，支持相似度检索 |
| **Embedding 模型** | `bge-large-zh-v1.5` 或 OpenAI `text-embedding-3-large` | 将文本转换为向量 |
| **元数据存储** | SQLite (单机) / PostgreSQL (生产) | 存储 PR 结构化字段 |
| **LLM** | Gemini / GPT-4 | 生成诊断报告 |

---

## 三、数据模型设计

### 3.1 PR 文档结构

```python
@dataclass
class PRDocument:
    # 原始信息
    key: str                    # XH2CONTI-22035
    summary: str                # 标题
    description: str            # 描述
    steps_to_reproduce: str     # 重现步骤
    comments: List[str]         # 评论
    
    # AI 清洗后的结构化字段
    module: str                 # 模块分类 (CCU/OTA/诊断/CAN通信)
    fault_type: str             # 故障类型 (通信异常/逻辑错误/配置问题)
    symptom_summary: str        # 症状摘要 (一句话)
    root_cause: Optional[str]   # 根因 (如已知)
    solution: Optional[str]     # 解决方案 (如已知)
    technical_tags: List[str]   # 技术标签 (UDS命令/CAN通道/版本号)
    
    # 状态
    status: str                 # 已解决/待修复/调查中
    quality_score: float        # 数据质量评分 (0-1)
    
    # 向量
    embedding: List[float]      # 768/1536 维向量
```

### 3.2 向量化策略

| 字段 | 向量化方式 | 说明 |
|---|---|---|
| 症状摘要 + 技术标签 | **主向量** | 用于语义检索 |
| 重现步骤 | 辅助向量 | 用于步骤相似度匹配 |
| 根因+方案 | 知识向量 | 用于已解决案例匹配 |

---

## 四、数据清洗管道

### 4.1 清洗流程

```
原始 PR
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Step 1: 字段提取                                        │
│ - 从 Jira 获取: summary, description, steps, comments   │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Step 2: AI 结构化                                       │
│ - 调用 LLM 提取: 模块、故障类型、症状摘要、根因、方案    │
│ - 生成技术标签                                          │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Step 3: 质量评估                                        │
│ - 评估信息完整度                                        │
│ - 评估根因/方案可靠性                                   │
│ - 计算质量评分                                          │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Step 4: 向量化                                          │
│ - 生成文本向量                                          │
│ - 存入向量数据库                                        │
└─────────────────────────────────────────────────────────┘
```

### 4.2 AI 清洗 Prompt

```python
CLEANING_PROMPT = """
请将以下 Jira PR 信息规范化为 JSON 格式：

### 原始信息
- 标题: {summary}
- 描述: {description}
- 重现步骤: {steps_to_reproduce}
- 评论: {comments}

### 输出要求
请提取并输出以下 JSON：
{
  "module": "模块分类，选择: CCU/OTA/诊断通信/CAN网络/SWITCH/HSM/电源管理/其他",
  "fault_type": "故障类型，选择: 通信异常/逻辑错误/配置问题/时序问题/硬件故障/环境问题/其他",
  "symptom_summary": "一句话描述问题本质，不超过50字",
  "root_cause": "根因分析，如未知则填 null",
  "solution": "解决方案，如未知则填 null",
  "technical_tags": ["技术标签列表，如 UDS命令、CAN通道ID、版本号、错误码等"]
}
"""
```

---

## 五、检索策略

### 5.1 多路召回

```
新 PR 查询
    │
    ├──────────────────────────────────────────────┐
    │                                              │
    ▼                                              ▼
┌─────────────────┐                    ┌─────────────────┐
│ 语义向量检索     │                    │ 元数据过滤      │
│ Top-30          │                    │ 模块=CCU        │
│                 │                    │ 状态=已解决     │
└────────┬────────┘                    └────────┬────────┘
         │                                      │
         └──────────────┬───────────────────────┘
                        │
                        ▼
               ┌─────────────────┐
               │    结果合并     │
               │    去重         │
               └────────┬────────┘
                        │
                        ▼
               ┌─────────────────┐
               │  Cross-Encoder  │
               │  精排 Top-10    │
               └────────┬────────┘
                        │
                        ▼
               ┌─────────────────┐
               │  返回给 LLM     │
               └─────────────────┘
```

### 5.2 检索参数

| 参数 | 推荐值 | 说明 |
|---|---|---|
| 初次召回数量 | 30 | 平衡召回率和效率 |
| 精排返回数量 | 10 | 控制 Token 消耗 |
| 相似度阈值 | 0.7 | 过滤低质量匹配 |
| 元数据过滤 | 模块相同 + 已解决 | 提高相关性 |

---

## 六、实施步骤

### Phase 1: 环境搭建 (2-3 天)

```bash
# 1. 安装依赖
pip install chromadb sentence-transformers langchain

# 2. 下载 Embedding 模型
# bge-large-zh-v1.5 (约 1.2GB)
```

### Phase 2: 数据导入 (1 周)

1. **编写 Jira 导出脚本** - 批量获取历史 PR，保存为 JSON
2. **运行 AI 清洗管道** - 调用 Gemini 进行结构化
3. **向量化与入库** - 存入 ChromaDB

### Phase 3: 检索服务开发 (1 周)

```python
# 核心检索代码示例
from chromadb import Client
from sentence_transformers import SentenceTransformer

class PRKnowledgeBase:
    def __init__(self):
        self.client = Client()
        self.collection = self.client.get_collection("pr_knowledge")
        self.model = SentenceTransformer('BAAI/bge-large-zh-v1.5')
    
    def search(self, query: str, top_k: int = 10, filters: dict = None):
        query_embedding = self.model.encode(query)
        results = self.collection.query(
            query_embeddings=[query_embedding],
            n_results=top_k,
            where=filters
        )
        return results
```

### Phase 4: 集成与测试 (1 周)

- 替换当前 JQL 检索逻辑
- A/B 测试对比效果
- 调优参数

---

## 七、优缺点分析

### ✅ 优点

| 优点 | 说明 |
|---|---|
| **语义理解** | 即使用词不同，语义相似的 PR 也能被召回 |
| **实现相对简单** | 成熟的开源工具链，2-3 周可上线 |
| **增量更新容易** | 新 PR 只需向量化后追加入库 |
| **减少 Token 消耗** | 只返回最相关的摘要，无需全文 |

### ⚠️ 缺点

| 缺点 | 说明 |
|---|---|
| **缺乏推理能力** | 只能检索相似案例，无法推导隐含关系 |
| **依赖数据质量** | 如果历史 PR 质量差，清洗后仍有噪音 |
| **无法处理复杂查询** | 如"CCU 通信问题通常由什么引起"需要遍历多条记录 |

---

## 八、成本估算

| 项目 | 一次性成本 | 持续成本 |
|---|---|---|
| **开发人力** | 2-3 人周 | - |
| **Embedding 模型** | 免费 (开源 bge) | - |
| **向量数据库** | 免费 (ChromaDB) | 服务器存储 |
| **AI 清洗** | ~$50 (清洗 1000 条 PR) | 新 PR 入库 |
| **LLM 推理** | - | 按使用量付费 |

---

## 九、参考代码结构

```
backend/
├── knowledge_base/
│   ├── __init__.py
│   ├── embeddings.py      # Embedding 模型封装
│   ├── vector_store.py    # 向量数据库操作
│   ├── data_cleaner.py    # AI 清洗管道
│   ├── retriever.py       # 检索逻辑
│   └── importer.py        # Jira 数据导入
├── data/
│   ├── raw/               # 原始 Jira 导出
│   ├── cleaned/           # 清洗后的结构化数据
│   └── chroma_db/         # 向量数据库文件
└── main.py
```

# 方案 C：知识图谱设计与实施方案

## 一、方案概述

**知识图谱 (Knowledge Graph)** 是一种以**图结构**表示领域知识的技术，通过**实体-关系-实体**三元组构建结构化的知识网络，支持复杂的关联查询和推理。

### 核心思想

```
┌─────────────────────────────────────────────────────────────┐
│                   知识图谱工作流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │               知识图谱 (Neo4j / 本地存储)                ││
│  │                                                         ││
│  │    [CCU模块] ──has_fault──> [通信异常]                  ││
│  │        │                        │                        ││
│  │    caused_by               manifests_as                  ││
│  │        ▼                        ▼                        ││
│  │  [白名单配置]              [非白名单报文外发]             ││
│  │        │                                                ││
│  │    solved_by                                            ││
│  │        ▼                                                ││
│  │  [更新配置表]                                            ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  新 PR 输入 → 实体识别 → 图谱查询 → 关联路径 → 诊断报告 ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、与 RAG 方案的对比

| 维度 | RAG 知识库 (方案 B) | 知识图谱 (方案 C) |
|---|---|---|
| **数据结构** | 扁平文档 + 向量 | 图结构 (节点 + 边) |
| **检索方式** | 语义相似度匹配 | 图遍历 + 关系推理 |
| **适合查询** | "找相似案例" | "CCU 问题通常由什么引起？" |
| **推理能力** | 弱（依赖 LLM） | 强（图谱本身可推理） |
| **实现复杂度** | 中等 | 高 |
| **维护成本** | 低（自动入库） | 高（需维护实体/关系） |
| **冷启动难度** | 低（有数据即可用） | 高（需先提取知识结构） |
| **扩展性** | 好（新文档直接加） | 需更新 Schema |

### 适用场景对比

| 场景 | 推荐方案 |
|---|---|
| "这个 PR 与哪些历史问题相似？" | **RAG** ✅ |
| "CCU 通信问题通常有哪些根因？" | **知识图谱** ✅ |
| "OTA 升级失败 → 可能原因 → 排查步骤" | **知识图谱** ✅ |
| "找到描述类似的历史 PR" | **RAG** ✅ |
| "这个错误码历史上出现过几次？解决方案是什么？" | **两者结合** ✅ |

---

## 三、知识图谱 Schema 设计

### 3.1 实体类型 (Nodes)

```
┌─────────────────────────────────────────────────────────────┐
│                       实体类型                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Module    │  │ FaultType   │  │  Symptom    │         │
│  │   (模块)    │  │ (故障类型)   │  │  (症状)     │         │
│  │             │  │             │  │             │         │
│  │ - CCU       │  │ - 通信异常   │  │ - 报文异常  │         │
│  │ - OTA       │  │ - 逻辑错误   │  │ - 升级失败  │         │
│  │ - SWITCH    │  │ - 配置问题   │  │ - 超时无响应│         │
│  │ - HSM       │  │ - 硬件故障   │  │ - 校验失败  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  RootCause  │  │  Solution   │  │    PR       │         │
│  │  (根因)     │  │  (解决方案)  │  │  (问题单)   │         │
│  │             │  │             │  │             │         │
│  │ - 白名单遗漏 │  │ - 更新配置  │  │ - Key       │         │
│  │ - 时序错误   │  │ - 修复代码  │  │ - Summary   │         │
│  │ - 版本不匹配 │  │ - 更换硬件  │  │ - Status    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │  ErrorCode  │  │  Component  │                          │
│  │  (错误码)   │  │  (组件)     │                          │
│  │             │  │             │                          │
│  │ - 0x7F      │  │ - CAN通道   │                          │
│  │ - NRC 11    │  │ - UDS服务   │                          │
│  └─────────────┘  └─────────────┘                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 关系类型 (Edges)

```
┌─────────────────────────────────────────────────────────────┐
│                       关系类型                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Module ──────────────────────> FaultType                   │
│          HAS_FAULT_TYPE                                     │
│          (模块常见故障类型)                                   │
│                                                             │
│  FaultType ───────────────────> Symptom                     │
│             MANIFESTS_AS                                    │
│             (故障类型表现为症状)                              │
│                                                             │
│  Symptom ─────────────────────> RootCause                   │
│            CAUSED_BY                                        │
│            (症状由根因导致)                                   │
│                                                             │
│  RootCause ───────────────────> Solution                    │
│              SOLVED_BY                                      │
│              (根因的解决方案)                                 │
│                                                             │
│  PR ──────────────────────────> Module                      │
│      BELONGS_TO                                             │
│      (PR 属于模块)                                           │
│                                                             │
│  PR ──────────────────────────> Symptom                     │
│      EXHIBITS                                               │
│      (PR 表现出症状)                                         │
│                                                             │
│  PR ──────────────────────────> RootCause                   │
│      HAS_ROOT_CAUSE                                         │
│      (PR 的根因)                                             │
│                                                             │
│  PR ──────────────────────────> ErrorCode                   │
│      CONTAINS_ERROR                                         │
│      (PR 包含错误码)                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 图谱可视化示例

```
                    ┌─────────────┐
                    │   CCU模块   │
                    └──────┬──────┘
                           │ HAS_FAULT_TYPE
                           ▼
                    ┌─────────────┐
        ┌───────────│  通信异常   │───────────┐
        │           └─────────────┘           │
        │ MANIFESTS_AS                MANIFESTS_AS
        ▼                                     ▼
┌───────────────┐                    ┌───────────────┐
│非白名单报文外发│                    │ CAN通道中断   │
└───────┬───────┘                    └───────┬───────┘
        │ CAUSED_BY                          │ CAUSED_BY
        ▼                                    ▼
┌───────────────┐                    ┌───────────────┐
│ 白名单配置遗漏 │                    │  时序冲突     │
└───────┬───────┘                    └───────┬───────┘
        │ SOLVED_BY                          │ SOLVED_BY
        ▼                                    ▼
┌───────────────┐                    ┌───────────────┐
│ 更新配置表     │                    │ 调整通信时序   │
└───────────────┘                    └───────────────┘
```

---

## 四、技术架构

### 4.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                       知识图谱系统                                   │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     知识抽取层                               │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐               │   │
│  │  │ Jira PR   │  │ 专家知识  │  │ 文档资料  │               │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘               │   │
│  │        └──────────────┼──────────────┘                      │   │
│  │                       ▼                                      │   │
│  │              ┌─────────────────┐                            │   │
│  │              │  AI 实体关系抽取 │                            │   │
│  │              │  (NER + RE)      │                            │   │
│  │              └────────┬────────┘                            │   │
│  └───────────────────────┼─────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     存储层                                   │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │              图数据库 (Neo4j / NetworkX)               │ │   │
│  │  │                                                       │ │   │
│  │  │  节点: Module, FaultType, Symptom, RootCause, PR...  │ │   │
│  │  │  边: HAS_FAULT, CAUSED_BY, SOLVED_BY, BELONGS_TO...  │ │   │
│  │  │                                                       │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     查询推理层                               │   │
│  │  ┌───────────────────────┐  ┌─────────────────────────────┐│   │
│  │  │    Cypher 查询引擎    │  │      路径推理算法           ││   │
│  │  │    (Neo4j)            │  │  (最短路径/模式匹配)        ││   │
│  │  └───────────────────────┘  └─────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────┘   │
│                          ▼                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     应用层                                   │   │
│  │  ┌───────────────────────┐  ┌─────────────────────────────┐│   │
│  │  │    诊断推理           │  │       知识问答              ││   │
│  │  │ (症状→根因→方案)      │  │  (自然语言→图谱查询)        ││   │
│  │  └───────────────────────┘  └─────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 技术选型

| 组件 | 轻量方案 | 生产方案 |
|---|---|---|
| **图数据库** | NetworkX (内存) | Neo4j (企业级) |
| **实体抽取** | LLM (Gemini/GPT) | SpaCy + 领域模型 |
| **关系抽取** | LLM Prompt | 训练 RE 模型 |
| **查询语言** | Python API | Cypher |

---

## 五、知识抽取管道

### 5.1 实体识别 (NER)

```python
ENTITY_EXTRACTION_PROMPT = """
请从以下 Jira PR 中提取实体：

### PR 信息
- 标题: {summary}
- 描述: {description}
- 重现步骤: {steps_to_reproduce}

### 需要提取的实体类型
1. Module (模块): CCU, OTA, SWITCH, HSM, CAN网络, 诊断通信 等
2. Symptom (症状): 具体的异常现象描述
3. ErrorCode (错误码): 如 0x7F, NRC 11, 28禁言 等
4. Component (组件): CAN通道, UDS服务, 白名单 等
5. RootCause (根因): 如果 PR 中提到了根因
6. Solution (解决方案): 如果 PR 中提到了解决方案

### 输出格式 (JSON)
{
  "entities": [
    {"type": "Module", "value": "CCU", "confidence": 0.95},
    {"type": "Symptom", "value": "非白名单报文外发", "confidence": 0.90},
    ...
  ]
}
"""
```

### 5.2 关系抽取 (RE)

```python
RELATION_EXTRACTION_PROMPT = """
请根据以下 PR 信息，抽取实体之间的关系：

### 已识别实体
{entities}

### PR 上下文
{context}

### 需要识别的关系类型
1. BELONGS_TO: PR → Module
2. EXHIBITS: PR → Symptom  
3. CAUSED_BY: Symptom → RootCause
4. SOLVED_BY: RootCause → Solution
5. CONTAINS_ERROR: PR → ErrorCode

### 输出格式 (JSON)
{
  "relations": [
    {"source": "XH2CONTI-22035", "relation": "BELONGS_TO", "target": "CCU"},
    {"source": "非白名单报文外发", "relation": "CAUSED_BY", "target": "白名单配置遗漏"},
    ...
  ]
}
"""
```

---

## 六、查询与推理

### 6.1 典型查询模式

#### 查询 1：症状 → 可能根因

```cypher
// Cypher 查询：给定症状，找所有可能的根因
MATCH (s:Symptom {name: "非白名单报文外发"})-[:CAUSED_BY]->(r:RootCause)
RETURN r.name AS root_cause, count(*) AS frequency
ORDER BY frequency DESC
```

#### 查询 2：根因 → 解决方案

```cypher
// Cypher 查询：给定根因，找解决方案
MATCH (r:RootCause {name: "白名单配置遗漏"})-[:SOLVED_BY]->(s:Solution)
RETURN s.name AS solution, s.description AS details
```

#### 查询 3：模块 → 常见问题路径

```cypher
// Cypher 查询：CCU 模块的完整故障链
MATCH path = (m:Module {name: "CCU"})-[:HAS_FAULT_TYPE]->(f:FaultType)
              -[:MANIFESTS_AS]->(s:Symptom)-[:CAUSED_BY]->(r:RootCause)
              -[:SOLVED_BY]->(sol:Solution)
RETURN path
```

#### 查询 4：相似 PR 查找

```cypher
// Cypher 查询：找与当前 PR 症状相同的历史 PR
MATCH (current:PR {key: "XH2CONTI-22035"})-[:EXHIBITS]->(s:Symptom)
      <-[:EXHIBITS]-(similar:PR)
WHERE similar.status = '已解决'
RETURN similar.key, similar.root_cause, similar.solution
```

### 6.2 推理能力示例

```
输入: "CCU 发送诊断请求后，报文异常外发"

图谱推理路径:
  1. 实体识别: Module=CCU, Symptom=报文异常外发
  2. 图谱查询: (CCU)-[:HAS_FAULT_TYPE]->(通信异常)-[:MANIFESTS_AS]->(报文异常)
  3. 根因查找: (报文异常)-[:CAUSED_BY]->[白名单配置遗漏, 时序冲突]
  4. 方案推荐: (白名单配置遗漏)-[:SOLVED_BY]->(更新配置表)

输出:
  - 可能根因: 白名单配置遗漏 (70%), 时序冲突 (30%)
  - 推荐方案: 检查并更新白名单配置表
  - 相似案例: XH2CONTI-21234, XH2CONTI-20876
```

---

## 七、实施步骤

### Phase 1: Schema 设计与验证 (1 周)

1. **确定实体类型** - 与领域专家讨论，确定模块/故障/根因分类
2. **定义关系类型** - 明确实体间的语义关系
3. **小规模验证** - 用 10-20 个典型 PR 手动构建图谱验证 Schema

### Phase 2: 知识抽取管道 (2 周)

1. **开发实体抽取 Prompt** - 针对汽车电子领域优化
2. **开发关系抽取 Prompt** - 确保关系抽取准确率
3. **批量处理历史 PR** - 构建初始知识图谱

### Phase 3: 图数据库搭建 (1 周)

```bash
# 轻量方案：NetworkX (内存图)
pip install networkx

# 生产方案：Neo4j
docker run -d --name neo4j -p 7474:7474 -p 7687:7687 neo4j
```

### Phase 4: 查询服务开发 (1 周)

```python
# 基于 NetworkX 的简化实现
import networkx as nx

class KnowledgeGraph:
    def __init__(self):
        self.graph = nx.DiGraph()
    
    def add_entity(self, entity_type: str, name: str, properties: dict = None):
        self.graph.add_node(name, type=entity_type, **(properties or {}))
    
    def add_relation(self, source: str, relation: str, target: str):
        self.graph.add_edge(source, target, relation=relation)
    
    def find_root_causes(self, symptom: str) -> list:
        """给定症状，找所有可能的根因"""
        causes = []
        for _, target, data in self.graph.out_edges(symptom, data=True):
            if data.get('relation') == 'CAUSED_BY':
                causes.append(target)
        return causes
    
    def find_solutions(self, root_cause: str) -> list:
        """给定根因，找解决方案"""
        solutions = []
        for _, target, data in self.graph.out_edges(root_cause, data=True):
            if data.get('relation') == 'SOLVED_BY':
                solutions.append(target)
        return solutions
```

### Phase 5: 与现有系统集成 (1 周)

- 诊断时先查图谱获取可能根因
- 结合 RAG 检索相似案例
- LLM 综合生成报告

---

## 八、优缺点分析

### ✅ 优点

| 优点 | 说明 |
|---|---|
| **结构化推理** | 可直接查询"症状→根因→方案"路径 |
| **知识沉淀** | 领域知识显式表达，可解释性强 |
| **复杂查询** | 支持"CCU 通信问题有哪些常见根因" |
| **知识复用** | 同一根因/方案可被多个 PR 引用 |

### ⚠️ 缺点

| 缺点 | 说明 |
|---|---|
| **建设成本高** | 需要领域专家参与 Schema 设计 |
| **冷启动困难** | 需要先填充基础知识才能有效查询 |
| **维护复杂** | 新类型问题需要更新 Schema |
| **抽取准确率** | 自动抽取可能有误，需人工校验 |

---

## 九、成本估算

| 项目 | 一次性成本 | 持续成本 |
|---|---|---|
| **Schema 设计** | 1 人周 (需专家参与) | - |
| **知识抽取开发** | 2 人周 | - |
| **图数据库** | 免费 (NetworkX) / $$ (Neo4j Enterprise) | 服务器 |
| **AI 抽取** | ~$100 (处理 1000 条 PR) | 新 PR 入库 |
| **人工校验** | 2-3 人天 (抽查 10%) | 持续抽查 |

---

## 十、推荐：RAG + 知识图谱混合方案

**最佳实践是两者结合**：

```
┌─────────────────────────────────────────────────────────────┐
│                    混合诊断流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  新 PR 输入                                                  │
│      │                                                       │
│      ├────────────────────────────────────────┐             │
│      │                                        │             │
│      ▼                                        ▼             │
│  ┌─────────────┐                      ┌─────────────┐       │
│  │ 知识图谱    │                      │ RAG 知识库  │       │
│  │ 推理可能根因│                      │ 检索相似案例│       │
│  └──────┬──────┘                      └──────┬──────┘       │
│         │                                    │              │
│         └──────────────┬─────────────────────┘              │
│                        │                                     │
│                        ▼                                     │
│               ┌─────────────────┐                           │
│               │  LLM 综合诊断  │                           │
│               │  (结合两路信息) │                           │
│               └─────────────────┘                           │
│                        │                                     │
│                        ▼                                     │
│               ┌─────────────────┐                           │
│               │    诊断报告     │                           │
│               └─────────────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 任务 | 使用组件 |
|---|---|
| "这个问题可能由什么引起？" | 知识图谱 |
| "历史上有类似案例吗？" | RAG |
| "综合诊断报告" | LLM + 两者结果 |
